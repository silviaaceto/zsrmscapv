/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.ui.dialog.factory");jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");jQuery.sap.require("sap.m.MessageBox");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("ui.s2p.srm.sc.approve.util.Formatter");jQuery.sap.require("ui.s2p.srm.sc.approve.util.ItemList");jQuery.sap.require("ui.s2p.srm.sc.approve.util.ObjectCache");jQuery.sap.require("sap.ca.ui.message.message");sap.ca.scfld.md.controller.BaseDetailController.extend("ui.s2p.srm.sc.approve.view.S3",{onInit:function(){sap.ca.scfld.md.controller.BaseDetailController.prototype.onInit.call(this);this.busyDialog=new sap.m.BusyDialog();this.oDataModel=this.oApplicationFacade.getODataModel();this.oPageCache=ui.s2p.srm.sc.approve.util.ObjectCache.getInstance();this.new_oDataModel=this.oApplicationFacade.getODataModel("CARTAPPROVAL_STANDARD");this.count=0;this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="detail"){this.description=undefined;var d=e.getParameter("arguments").contextPath;d=d.split("WorkflowTaskCollection(")[1].split(")")[0];var s=d.split(",");var w=s[1].split("=")[1].replace(/'/g,"");var S=s[0];this.oServerName=s[0].split("=")[1];this.busyDialog.open();this.readContent(S,w);if(this.oPageCache.isEmpty()||this.oPageCache.getId()!==w){this.oPageCache.clear();this.oPageCache.setId(w);}}},this);this.setHeaderFooterOptions(this.createHeaderFooterOptions());},createHeaderFooterOptions:function(){var t=this;return{sI18NDetailTitle:"DETAIL_TITLE",oPositiveAction:{sId:"approveBtn",sI18nBtnTxt:"APPROVE",onBtnPressed:function(){jQuery.proxy(t.handleApprove(),this);}},oNegativeAction:{sId:"rejectBtn",sI18nBtnTxt:"REJECT",onBtnPressed:function(){jQuery.proxy(t.handleReject(),this);}},buttonList:[{sId:"inquireBtn",sI18nBtnTxt:"INQUIRE",onBtnPressed:function(e){jQuery.proxy(t.handleInquire(e),this);}},{sId:"sendBtn",sI18nBtnTxt:"SEND",onBtnPressed:function(e){jQuery.proxy(t.handleSend(e),this);}},{sId:"forwardBtn",sI18nBtnTxt:"FORWARD",onBtnPressed:function(e){jQuery.proxy(t.handleForward(e),this);}}],oAddBookmarkSettings:{title:t.oApplicationFacade.getResourceBundle().getText("DETAIL_TITLE"),icon:"sap-icon//cart"},onBack:jQuery.proxy(function(){var d=sap.ui.core.routing.History.getInstance().getDirection(this.oRouter.getURL("master"));if(d==="Backwards"){window.history.go(-1);}else{this.oRouter.navTo("master");}},this)};},readContent:function(s,w){var o=function(d,r){this.bindView(d);};this.oDataModel.setHeaders({"X-Requested-With":"XMLHttpRequest","Content-Type":"application/atom+xml"});this.oDataModel.read("WorkflowTaskCollection("+s+",WorkitemID='"+w+"')/SCAHeader",null,["$expand=SCAAttachmentHeader,SCANoteHeader,SCAApproverHeader,SCAItem/SCAAttachmentItem,SCAItem/SCANoteItem"],true,jQuery.proxy(o,this),jQuery.proxy(this.onRequestFailed,this));if(this.extHook2){this.extHook2();};},bindView:function(d){this.description=d;this.getView().byId('icontabBar').setSelectedKey("Information");this.getView().byId('icontabBar').setExpanded(true);this.getView().setModel(new sap.ui.model.json.JSONModel(d),"description");ui.s2p.srm.sc.approve.util.ItemList.item.clear();for(var i=0;i<d.SCAItem.results.length;i++){ui.s2p.srm.sc.approve.util.ItemList.item.add(d.SCAItem.results);}this.showApproveRejectSendButtons(d.ApprovalOnItemlevel,d.isInquireWorkflow);if(this.extHookBind){this.extHookBind(d);}this.updateItemStateFromCache();this.busyDialog.close();},handleUserNameClick:function(c,e){var p=this.getEmployeeImage(e);var o=function(d,r){var E={imgurl:p,name:d.results[0].FullName,department:"",contactmobile:d.results[0].MobilePhone,contactphone:d.results[0].WorkPhone,companyname:d.results[0].CompanyName,contactemail:d.results[0].EMail,contactemailsubj:"",companyaddress:d.results[0].AddressString};var a=new sap.ca.ui.quickoverview.EmployeeLaunch(E);a.openBy(c);};this.oDataModel.read("UserDetailsCollection",null,["$filter=UserID eq '"+e+"' and SAP__Origin eq "+this.oServerName],false,jQuery.proxy(o,this),jQuery.proxy(this.onRequestFailed,this));},onApproverPress:function(e){if(e.getSource().getModel('description')){var i=parseInt(e.getSource().getBindingContextPath().split('/')[3]);var a=this.description.SCAApproverHeader.results;var s=e.getParameters().id;var c=this.getView().byId(s);this.handleUserNameClick(c,a[i].ApproverID);}},onCreatorPress:function(e){var c=this.getView().byId("DetailHeader");this.handleUserNameClick(c,this.description.CreatedByID);},onPersonNamePress:function(e){var c=this.getView().byId("ATTR2");var i="";if(this.description.ForwardedByID){i=this.description.ForwardedByID;}else if(this.description.SubstitutingForID){i=this.description.SubstitutingForID;}else{i=this.description.OnBehalfOfID;}this.handleUserNameClick(c,i);},onNotePersonPress:function(e){if(e.getSource().getModel('description')){var i=parseInt(e.getSource().getBindingContextPath().split('/')[3]);var a=this.description.SCANoteHeader.results;var c=this.getView().byId("Notes");this.handleUserNameClick(c,a[i].CreatedByID);}},handleApprove:function(){var d=this.description;var b=this.oApplicationFacade.getResourceBundle();var a=new sap.m.Dialog("approveDialog",{title:b.getText("APPROVE"),content:[new sap.m.Text({text:b.getText("APPROVESC_BY",[d.CreatedByName])}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.TextArea({width:"100%",placeholder:b.getText("ADDNOTE"),})],beginButton:new sap.m.Button({text:b.getText("OK"),press:function(){this.busyDialog.open();this.onApprove(a);}.bind(this)}),endButton:new sap.m.Button({text:b.getText("CANCEL"),press:function(){this.fnClose(a);}.bind(this)}),afterClose:function(){a.destroy();}});a.addStyleClass("sapUiContentPadding");a.open();},handleReject:function(){var d=this.description;var b=this.oApplicationFacade.getResourceBundle();var r=new sap.m.Dialog("rejectDialog",{title:b.getText("REJECT"),content:[new sap.m.Text({text:b.getText("REJECTSC_BY",[d.CreatedByName]),}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.TextArea({width:"100%",placeholder:b.getText("ADDNOTE"),})],beginButton:new sap.m.Button({text:b.getText("OK"),press:function(){this.busyDialog.open();this.onReject(r);}.bind(this)}),endButton:new sap.m.Button({text:b.getText("CANCEL"),press:function(){this.fnClose(r);}.bind(this)}),afterClose:function(){r.destroy();}});r.addStyleClass("sapUiContentPadding");r.open();},handleSend:function(e){var d=this.description;var b=this.oApplicationFacade.getResourceBundle();var a=this.byId('itemList').getItems();var c=0;var r=0;for(var i=0;i<a.length;i++){if(a[i].getCells()[0].bOutput!="invisible"){if(a[i].getCells()[0].getProperty('state')==true){c++;}else{r++;}}}var s=new sap.m.Dialog("sendDialog",{title:b.getText("SEND"),content:[new sap.m.Text({text:b.getText("DECISION",[d.CreatedByName])+"\n\n"+b.getText("APPROVED_ITEMS")+" "+c+"\n"+b.getText("REJECTED_ITEMS")+" "+r,}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.TextArea({width:"100%",placeholder:b.getText("ADDNOTE"),})],beginButton:new sap.m.Button({text:b.getText("SEND"),press:function(){this.busyDialog.open();this.onApproveRejectAtItemLevel(s);}.bind(this)}),endButton:new sap.m.Button({text:b.getText("CANCEL"),press:function(){this.fnClose(s);}.bind(this)}),afterClose:function(){s.destroy();}});s.addStyleClass("sapUiContentPadding");s.open();},handleForward:function(c){var s=function(q){var p=this.oDataModel.sServiceUrl;this.oDataModel.read("/ForwardingAgentCollection",null,["$filter=SearchForText eq '"+q+"'and SAP__Origin eq "+this.oServerName],true,jQuery.proxy(function(d,r){sap.ca.ui.dialog.forwarding.setFoundAgents(d.results);},this),jQuery.proxy(this.onSearchRequestFailed,this));};sap.ca.ui.dialog.forwarding.start(jQuery.proxy(s,this),jQuery.proxy(this.ForwardingAgentCollection,this));},onItemApproveChange:function(e){var i=e.getSource().getBindingInfo("visible").binding.oContext.getPath().split("/")[3];var a=this.byId("itemList").getItems();if(i!==-1){this.oPageCache.setKey(i,e.getSource().getProperty("state"));}},onApprove:function(d){d.close();var D=this.description;this.sTextKey="APPROVED";this.sSuccessMsg=this.oApplicationFacade.getResourceBundle().getText(this.sTextKey)+"\n";var e={};var s=this.oServerName.replace(/'/g,"");e.Comment=(d.getContent()[1].getValue())?(d.getContent()[1].getValue()):"";e.WorkitemID=D.WorkitemID;e.DecisionKey="001";e.ScNumber=D.ScNumber;var p=this.oDataModel.sServiceUrl;var S={success:jQuery.proxy(this._handleApproveRejectSuccess,this),error:jQuery.proxy(this.onRequestFailed,this),async:true};this.oDataModel.create("ApplyDecision?WorkitemID='"+D.WorkitemID+"'&DecisionKey='001'&Comment='"+encodeURIComponent(e.Comment)+"'&SAP__Origin='"+s+"'",e,S);},onReject:function(d){d.close();var D=this.description;this.sTextKey="REJECTED";this.sSuccessMsg=this.oApplicationFacade.getResourceBundle().getText(this.sTextKey)+"\n";var e={};var s=this.oServerName.replace(/'/g,"");e.Comment=(d.getContent()[1].getValue())?(d.getContent()[1].getValue()):"";e.WorkitemID=D.WorkitemID;e.DecisionKey="002";var p=this.oDataModel.sServiceUrl;var S={success:jQuery.proxy(this._handleApproveRejectSuccess,this),error:jQuery.proxy(this.onRequestFailed,this),async:true};this.oDataModel.create("ApplyDecision?WorkitemID='"+D.WorkitemID+"'&DecisionKey='001'&Comment='"+encodeURIComponent(e.Comment)+"'&SAP__Origin='"+s+"'",e,S);},ForwardingAgentCollection:function(r){var d=this.description;if(r&&r.bConfirmed){this.oSelectedAgent=r.oAgentToBeForwarded;var e={};e.Comment=(r.sNote)?r.sNote:"";e.WorkitemID=d.WorkitemID;e.NewApprover=this.oSelectedAgent.UserId;var s=this.oServerName.replace(/'/g,"");var p=this.oApplicationFacade.getODataModel().sServiceUrl;var S={success:jQuery.proxy(this._handleForwardSuccess,this),error:jQuery.proxy(this.onRequestFailed,this),async:true};this.oDataModel.create("ApplyDecision?WorkitemID='"+d.WorkitemID+"'&DecisionKey='001'&Comment='"+encodeURIComponent(e.Comment)+"'&SAP__Origin='"+s+"'",e,S);}},_handleApproveRejectSuccess:function(){var p=this.oDataModel.sServiceUrl;this.oDataModel.sServiceUrl=p.split(";")[0]+";v=2;mo";var c=sap.ui.core.Component.getOwnerIdFor(this.oView);var C=sap.ui.component(c);C.oEventBus.publish("ui.s2p.srm.sc.approve","approveShoppingCart");this.oDataModel.setRefreshAfterChange(true);this.oDataModel.refresh(true);sap.m.MessageToast.show(this.sSuccessMsg,{closeOnBrowserNavigation:false});this.busyDialog.close();},_handleForwardSuccess:function(){var p=this.oDataModel.sServiceUrl;this.oDataModel.sServiceUrl=p.split(";")[0]+";v=2;mo";var c=sap.ui.core.Component.getOwnerIdFor(this.oView);var C=sap.ui.component(c);C.oEventBus.publish("ui.s2p.srm.sc.approve","approveShoppingCart");this.oDataModel.setRefreshAfterChange(true);this.oDataModel.refresh(true);var m=this.oApplicationFacade.getResourceBundle().getText("FORWARDED",[this.oSelectedAgent.FullName])+"\n";sap.m.MessageToast.show(m);},onApproveRejectAtItemLevel:function(d){d.close();var D=this.description;var a=[];this.sTextKey="APPROVED";var r=0;for(var i=0;i<D.SCAItem.results.length;i++){var o={};if(D.SCAItem.results[i].ApprovalOnItemlevel==="X"){if(this.byId('itemList').getItems()[i].getCells()[0].getProperty('state')==true){o.ItemApproved=D.SCAItem.results[i].ApprovalOnItemlevel;}else{o.ItemApproved='0';r++;}o.ItemNumber=D.SCAItem.results[i].ItemNumber;a.push(o);}}if(r==D.SCAItem.results.length){this.sTextKey="REJECTED";this.sSuccessMsg=this.oApplicationFacade.getResourceBundle().getText(this.sTextKey)+"\n";}else if(r===0){this.sTextKey="APPROVED";this.sSuccessMsg=this.oApplicationFacade.getResourceBundle().getText(this.sTextKey)+"\n";}else if(r===0){this.sTextKey="FORWARDED";this.sSuccessMsg=this.oApplicationFacade.getResourceBundle().getText(this.sTextKey)+"\n";}else{this.sTextKey="PARTAPPROVED";this.sSuccessMsg=this.oApplicationFacade.getResourceBundle().getText(this.sTextKey,[D.SCAItem.results.length-r,r])+"\n";}var s=this.oServerName.replace(/'/g,"");var e={};e.Comment=(d.getContent()[1].getValue())?d.getContent()[1].getValue():"";e.WorkitemID=D.WorkitemID;e.ScNumber=D.ScNumber;e.SCAIBAItem=a;var p=this.new_oDataModel.sServiceUrl;var c=p.replace(";mo",";o="+s);this.new_oDataModel.sServiceUrl=c;var S={success:jQuery.proxy(this._handleApproveRejectSuccess,this),error:jQuery.proxy(this.onRequestFailed,this),async:true};this.new_oDataModel.create("SCAIBAHeaderCollection",e,S);this.new_oDataModel.sServiceUrl=p;},onRequestFailed:function(e){this.busyDialog.close();var b=this.oApplicationFacade.getResourceBundle();this.oDataModel.setRefreshAfterChange(true);if(this.oDataModel.hasPendingChanges()){this.oDataModel.refresh(true);}var m=new Array();if(e.response){if(e.response.body){if(jQuery.parseJSON(e.response.body).error.innererror.errordetails){for(var i=0;i<jQuery.parseJSON(e.response.body).error.innererror.errordetails.length;i++){m.push(jQuery.parseJSON(e.response.body).error.innererror.errordetails[i].message);}}}}var a='';if(m.length>0){for(var i=0;i<m.length;i++){a=m[i]+'\n'+'\n'+a;}}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:b.getText("ERROR_MESS"),details:a});},onSearchRequestFailed:function(e){this.busyDialog.close();var b=this.oApplicationFacade.getResourceBundle();sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:b.getText("SEARCH_MESS")});},updateItemStateFromCache:function(e){if(this.description){if(this.description.ApprovalOnItemlevel==="X"&&!this.oPageCache.isEmpty()){for(var i=0;i<this.description.NumberOfItems;i++){var s=this.oPageCache.getValue(i);if(s!==undefined){this.byId("itemList").getItems()[i].getCells()[0].setProperty("state",s);}}}else{for(var i=0;i<this.description.NumberOfItems;i++){this.byId("itemList").getItems()[i].getCells()[0].setProperty("state",true);}}}},showApproveRejectSendButtons:function(b,c){if(b===""){this.byId('itemList').getColumns()[0].setVisible(false);var B=this.createHeaderFooterOptions();B=this.showInquireButton(B,c);for(var i=0;i<B.buttonList.length;i++){var a=10;if(B.buttonList[i].sId==="sendBtn"){B.buttonList.splice(i,1);}}this.setHeaderFooterOptions(B);}else{this.getView().byId('itemList').getColumns()[0].setVisible(true);var d=this.createHeaderFooterOptions();d.oPositiveAction=null;d.oNegativeAction=null;d=this.showInquireButton(d,c);this.setHeaderFooterOptions(d);this.setBtnEnabled("sendBtn",true);}this.isInquireIntentSupported();},handleInquire:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=f&&f("CrossApplicationNavigation");var d=this.description;var h=(this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"ShoppingCartItem",action:"inquire"},params:{"SAPSRM_BO_NO":d.ScNumber,"SAPSRM_WIID":d.WorkitemID}}));if(h){sap.m.URLHelper.redirect(h);}},showInquireButton:function(o,b){if(b===""||b===undefined||sap.ui.Device.system.tablet===true||sap.ui.Device.system.phone===true){for(var i=0;i<o.buttonList.length;i++){var a=10;if(o.buttonList[i].sId==="inquireBtn"){o.buttonList.splice(i,1);}}}return o;},moveToItemDetail:function(e){var w=e.getSource().getModel('description').getData().WorkitemID;var i=e.getSource().getBindingContextPath().split('/')[3];var a=e.getSource().getModel('description').getData().SCAItem.results[i].ItemNumber;var s=e.getSource().getModel('description').getData().ScNumber;var b=this.oServerName;this.oRouter.navTo("detailItem",{workItemId:w,itemIndex:i,itemNumber:a,scNumber:s,servername:b},true);},navToEmpty:function(){this.oRouter.navTo("noData");},formatEmployee:function(e){if(e.getParameters().key==="approver"){var v="";var s=this.oServerName.replace(/'/g,"");var a=this.description.SCAApproverHeader.results;for(var i=0;i<a.length;i++){var S=function(d,r){if(r.body.length===0){v=jQuery.sap.getModulePath("ui.s2p.srm.sc.approve")+"/img/"+"person_placeholder.png";this.getView().byId("Approval_list").getItems()[i].setIcon(v);}else{v=r.requestUri;this.getView().byId("Approval_list").getItems()[i].setIcon(v);}this.oDataModel.sServiceUrl=this.oDataModel.sServiceUrl.split(";")[0]+";v=2;mo";};var E=function(o){v=jQuery.sap.getModulePath("ui.s2p.srm.sc.approve")+"/img/"+"person_placeholder.png";this.getView().byId("Approval_list").getItems()[i].setIcon(v);this.oDataModel.sServiceUrl=this.oDataModel.sServiceUrl.split(";")[0]+";v=2;mo";};var b=a[i].ApproverID;this.new_oDataModel.read("UserDetailsCollection('"+b+"')/$value",null,null,false,jQuery.proxy(S,this),jQuery.proxy(E,this));}}},getEmployeeImage:function(e){var v="";var s=this.oServerName.replace(/'/g,"");var S=function(d,r){if(r.body.length===0){v=jQuery.sap.getModulePath("ui.s2p.srm.sc.approve")+"/img/"+"person_placeholder.png";}else{v=r.requestUri;}this.oDataModel.sServiceUrl=this.oDataModel.sServiceUrl.split(";")[0]+";v=2;mo";};var E=function(o){v=jQuery.sap.getModulePath("ui.s2p.srm.sc.approve")+"/img/"+"person_placeholder.png";this.oDataModel.sServiceUrl=this.oDataModel.sServiceUrl.split(";")[0]+";v=2;mo";};this.new_oDataModel.read("UserDetailsCollection('"+e+"')/$value",null,null,false,jQuery.proxy(S,this),jQuery.proxy(E,this));return v;},onItemsLoaded:function(e){this.updateItemStateFromCache(e);},isMainScreen:function(){return true;},isInquireIntentSupported:function(){var c=this;if(c.isInquireIntentSupportedFlag===false){c.setBtnEnabled("inquireBtn",false);}else{var i=["#ShoppingCartItem-inquire?SAPSRM_BO_NO="+this.description.ScNumber+"&SAPSRM_WIID="+this.description.WorkitemID];var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=f&&f("CrossApplicationNavigation");if(this.oCrossAppNavigator!==undefined){this.oCrossAppNavigator.isIntentSupported(i).done(function(r){if(r[i[0]].supported!==true){c.setBtnEnabled("inquireBtn",false);c.isInquireIntentSupportedFlag=false;}}).fail(function(){c.setBtnEnabled("inquireBtn",false);c.isInquireIntentSupportedFlag=false;});}}},fnClose:function(d){d.close();}});
